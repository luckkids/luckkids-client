# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

default_platform(:ios)

platform :ios do
  def read_version_file
    version_file = 'version.txt'
    if File.exist?(version_file)
      content = File.read(version_file).strip
      if content =~ /(\d+\.\d+\.\d+) \((\d+)\)/
        { version: $1, build: $2 }
      else
        UI.user_error!("Invalid version format in version.txt. Expected format: X.Y.Z (Build)")
      end
    else
      UI.user_error!("version.txt file not found")
    end
  end

  def generate_build_number
    last_build = get_build_number(xcodeproj: "LuckKids.xcodeproj").to_i
    new_build_base = last_build + 1
    date = Time.now.strftime("%Y%m%d")
    commit_count = number_of_commits
    "#{new_build_base}.#{date}.#{commit_count}"
  end

  def update_version(options)
    current_version_info = read_version_file
    
    if options[:version]
      new_version = options[:version]
    else
      new_version = prompt(text: "Enter new version (current: #{current_version_info[:version]}) or 'skip' to use current: ")
      new_version = current_version_info[:version] if new_version.downcase == 'skip' || new_version.empty?
    end
  
    new_build = (current_version_info[:build].to_i + 1).to_s
  
    File.write('version.txt', "#{new_version} (#{new_build})")
    
    increment_version_number(
      version_number: new_version,
      xcodeproj: "LuckKids.xcodeproj"
    )
    increment_build_number(
      build_number: new_build,
      xcodeproj: "LuckKids.xcodeproj"
    )
  
    UI.message("Version updated to #{new_version} (#{new_build})")
  end

  def update_build_number
    new_build = generate_build_number
    increment_build_number(
      build_number: new_build,
      xcodeproj: "LuckKids.xcodeproj"
    )
    UI.message("Build number set to #{new_build}")
    new_build
  end

  def commit_and_push_version_bump(lane)
    # Ensure we're on the main branch
    ensure_git_branch(branch: 'main')
    
    # Check if there are any changes
    status = Actions.sh("git status --porcelain")
    if status.empty?
      UI.message("No changes to commit.")
      return
    end

    # Commit the version bump
    version = get_version_number(xcodeproj: "LuckKids.xcodeproj")
    build = get_build_number(xcodeproj: "LuckKids.xcodeproj")
    commit_message = "Bump version to #{version} (#{build}) [#{lane}]"
    
    git_add(path: "*.plist")
    git_add(path: "*.pbxproj")
    git_add(path: "version.txt")
    git_commit(path: ".", message: commit_message)

    # Push to remote using push_to_git_remote action
    push_to_git_remote(
      remote: "origin",  # remote name, usually "origin"
      local_branch: "main",  # local branch name
      remote_branch: "main",  # remote branch name
      force: false,  # set to true if you need to force push
      tags: false  # set to true if you want to push tags as well
    )

    UI.success("Successfully pushed version bump!")
  end

  desc "Push a new beta build to TestFlight with version prompt"
  lane :beta do |options|
    cert
    sigh(force: true)
    update_version(options)
    build_app(workspace: "LuckKids.xcworkspace", scheme: "LuckKids")
    upload_to_testflight
    commit_and_push_version_bump("beta")
  end
  
  desc "Push a new beta build to TestFlight, only updating build number"
  lane :beta_build_only do
    cert
    sigh(force: true)
    current_version_info = read_version_file
    new_build = (current_version_info[:build].to_i + 1).to_s
    File.write('version.txt', "#{current_version_info[:version]} (#{new_build})")
    increment_build_number(
      build_number: new_build,
      xcodeproj: "LuckKids.xcodeproj"
    )
    build_app(workspace: "LuckKids.xcworkspace", scheme: "LuckKids")
    upload_to_testflight
    commit_and_push_version_bump("beta_build_only")
  end
end